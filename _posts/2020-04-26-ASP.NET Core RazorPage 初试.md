---
layout: default
title:  "ASP.NET Core RazorPages 初试"
---
最近新建asp。net mvc项目的时候不小心选错了个模板，发现了一种新的项目结构。它使用cshtml试图模板，但是没有Controller文件夹。后来才发现者是asp.net core新推出的razor page技术。
## 什么是razor pages
razor pages 使编码更加简单更加富有生产力，这是微软说的==！。razor pages简化了传统的mvc模式，仅仅使用试图跟模型来完成网页的渲染跟业务逻辑的处理。模型里包含了数据跟方法，通过绑定技术跟视图建立联系。这就有点像服务端的绑定技术。下面使用一个标准的CRUD示例来试试Razor pages到底是何物。
## 新建razor pages项目
在visual studio中新建razor pages项目。    
![](https://s1.ax1x.com/2020/04/26/J2bbD0.md.png)    
项目结构    
![](https://s1.ax1x.com/2020/04/26/J2LJw6.png)     
新建项目的目录结构比mvc项目简单。它没有Controllers目录，Pages有点像mvc项目的Views目录，里面存放了cshtml模板。随便点开一个cshtml文件，发现它都包含了一个cs文件。这是跟mvc项目最大的不同，这个结构让人回忆起那古老的webform技术，o(╥﹏╥)o 。     
![](https://s1.ax1x.com/2020/04/26/J2XnxJ.md.png)
## 新建Razor Page
我们模拟开发一个学生管理系统。一共包含4个页面：列表页面、新增页面、修改页面、删除页面。首先我们新增一个列表页面。     
在Pages目录下面新建Student目录。在Student目录下新建一个4个Razor page名叫：List、Add、Update、Delete。   
![](https://s1.ax1x.com/2020/04/26/J2jsmR.md.png)     
建好后目录结构是这样：    
![](https://s1.ax1x.com/2020/04/26/J2xYGT.png)     
## 模拟数据访问仓储
由于这是个演示项目，所以我们使用静态变量来简单模拟下数据持久。    
在项目下新建一个Data目录，在目录下新建Student实体类：    
```
    public class Student
    {
        public int Id { get; set; }
        public string Name { get; set; }

        public string Class { get; set; }

        public int Age { get; set; }

        public string Sex { get; set; }
    }
```
在Data目录下新建IStudentRepository跟StudentRepository：
```
    public interface IStudentRepository
    {
        List<Student> List();

        Student Get(int id);

        bool Add(Student student);

        bool Update(Student student);

        bool Delete(int id);
    }

    public class StudentRepository : IStudentRepository
    {
        private static List<Student> Students = new List<Student> {
                new Student{ Id=1, Name="小红", Age=10, Class="1班", Sex="女"},
                new Student{ Id=2, Name="小明", Age=11, Class="2班", Sex="男"},
                new Student{ Id=3, Name="小强", Age=12, Class="3班", Sex="男"}
        };

        public bool Add(Student student)
        {
            Students.Add(student);

            return true;
        }

        public bool Delete(int id)
        {
            var stu = Students.FirstOrDefault(s => s.Id == id);
            if (stu != null)
            {
                Students.Remove(stu);
            }

            return true;
        }

        public Student Get(int id)
        {
            return Students.FirstOrDefault(s=>s.Id == id);
        }

        public List<Student> List()
        {
            return Students;
        }

        public bool Update(Student student)
        {
            var stu = Students.FirstOrDefault(s=>s.Id == student.Id);
            if (stu != null)
            {
                Students.Remove(stu);
            }

            Students.Add(student);
            return true;
        }
    }
```
我们新建了一个Repository的接口，里面有几个基本的crud的方法。然后新建一个实现类，并且使用静态变量保存数据，模拟数据持久化。
## 实现列表(student/list)页面
列表页面用来展现所有的学生信息。
修改ListModel类：
```
    public class ListModel : PageModel
    {
        private readonly IStudentRepository _studentRepository;
        public List<Student> Students { get; set; }
        public ListModel(IStudentRepository studentRepository) 
        {
            _studentRepository = studentRepository;
        }

        public void OnGet()
        {
            Students = _studentRepository.List();
        }
    }
```
修改List.cshtml模板：
```
@page
@model RazorPageCRUD.ListModel
@{
    ViewData["Title"] = "List";
}

<h1>List</h1>

<p>
    <a class="btn btn-primary" asp-page="Add">Add</a>
</p>
<table class="table">
    <tr>
        <th>Id</th>
        <th>Name</th>
        <th>Age</th>
        <th>Class</th>
        <th>Sex</th>
        <th></th>
    </tr>
    @foreach (var student in Model.Students)
    {
        <tr>
            <td>@student.Id</td>
            <td>@student.Name</td>
            <td>@student.Age</td>
            <td>@student.Class</td>
            <td>@student.Sex</td>
            <td>
                <a class="btn btn-primary" asp-page="Update" asp-route-id="@student.Id">Update</a>
                <a class="btn btn-danger" href="/student/delete?id=@student.Id" >Delete</a>
            </td>
        </tr>
    }

</table>
```
ListModel类混合了mvc的Controller跟model的概念。它本身可以认为是mvc里面的那个model。它的包含的数据，可以被razor试图引擎使用，用来生成html，比如它的Students属性。但是它又包含方法，可以用来处理业务逻辑，这个方法可以认为是Controller中的action。这个方法通过特殊的前缀来跟前端的请求做绑定。比如OnGet方法就是对Get请求作出响应，OnPost则是对Post请求作出响应。    
运行一下并且访问/student/list：    
![](https://s1.ax1x.com/2020/04/26/JRVAdU.md.png)